name: CI

on:
  push:
    branches: ["master"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install -r req.txt

      - name: Run tests
        run: |
          pytest --maxfail=1
       

      - name: Send CI failure to DevStream AI
        if: failure()
        run: |
          echo "Tests failed. Sending error to DevStream AI..."

          ERROR_LOG=$(pytest --maxfail=1 2>&1 || true)

          ESCAPED_LOG=$(printf "%s" "$ERROR_LOG" \
            | sed ':a;N;$!ba;s/\n/\\n/g' \
            | sed 's/"/\\"/g')

          CODE_CONTENT=$(sed ':a;N;$!ba;s/\n/\\n/g' src/calc.py \
            | sed 's/"/\\"/g')

                curl -X POST "https://dressiest-terese-nontemperable.ngrok-free.dev/api/send_ci_failure" \
            -H "Content-Type: application/json" \
            -d "{
                  \"repo_owner\": \"anjalikasingh2003\",
                  \"repo_name\": \"Dummy\",
                  \"branch\": \"master\",
                  \"commit\": \"${GITHUB_SHA}\",
                  \"log\": \"$ESCAPED_LOG\",
                  \"file_path\": \"src/calc.py\",
                  \"code\": \"$CODE_CONTENT\"
                }"



